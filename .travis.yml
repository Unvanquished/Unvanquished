sudo: required
services:
  - docker

os:
  - linux
  - osx

language:
  - cpp

python:
  - "2.7"

env:
  - MODE=1
  - MODE=2

compiler:
  - clang
  - gcc

matrix:
  exclude:
    - env: MODE=2  # Don't build NaCl gamelogic with gcc
      compiler: gcc

install:
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo rm -rf /opt/python; fi  # Delete conflicting python
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo apt-get -qq install software-properties-common; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo apt-get -qq update; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo apt-get -y install
    ninja-build libegl1-mesa-dev
    liblua5.2-dev libgles2-mesa-dev
    libgeoip-dev libncursesw5-dev
    libsdl2-dev libglew-dev libfreetype6-dev
    libwebp-dev libjpeg8-dev libpng-dev
    libcurl4-gnutls-dev zlib1g-dev
    libopenal-dev libogg-dev libvorbis-dev libtheora-dev libxvidcore-dev libopusfile-dev libspeexdsp-dev
    nettle-dev libgmp-dev python-yaml python-jinja2; fi
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then brew update; fi
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then brew install ninja; fi
  - pip2 install --user -r src/utils/cbse/requirements.txt

script:
  - mkdir -p build
  - cd build
  - cmake --version
  - CXXFLAGS="-D__extern_always_inline=inline" cmake -DUSE_PRECOMPILED_HEADER=0
    -DBUILD_CLIENT=0 -DBUILD_TTY_CLIENT=0 -DBUILD_SERVER=0
    -DBUILD_GAME_NATIVE_DLL=$(($MODE == 1)) -DBUILD_GAME_NATIVE_EXE=$(($MODE == 1))
    -DBUILD_GAME_NACL=$(($MODE == 2))
    -DUSE_WERROR=1 -DBE_VERBOSE=1 -G "Ninja" -DBUILD_GAME_NACL_NEXE=0 -DCMAKE_BUILD_TYPE=Debug ..
  - cmake --build . -- -j8

notifications:
  irc:
    - "irc.freenode.org#unvanquished-dev"
    - "irc.quakenet.org#unvanquished"
  on_success: change
  on_failure: always

branches:
  except:
    - /^cbse\/.*$/
    - debian
